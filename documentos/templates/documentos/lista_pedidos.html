{% extends 'documentos/base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold mb-1">
                <i class="bi bi-file-earmark-text me-2 text-primary"></i>Pedidos de Documentos
            </h2>
            <p class="small mb-0">
                {% if user.tipo == 'CONTABILIDADE' %}
                    Gerencie todas as solicitações enviadas aos seus clientes.
                {% else %}
                    Acompanhe e envie os documentos solicitados pela contabilidade.
                {% endif %}
            </p>
        </div>
        
        {% if user.tipo == 'CONTABILIDADE' %}
            <div class="d-flex gap-2">
                <a href="{% url 'lista_agendamentos' %}" class="btn btn-primary rounded-pill px-4 shadow-sm">
                    <i class="bi bi-calendar-range me-2"></i>Agendar Pedidos
                </a>
                
                <a href="{% url 'criar_pedido' %}" class="btn btn-primary rounded-pill px-4 shadow-sm">
                    <i class="bi bi-plus-lg me-2"></i>Pedido de Documento
                </a>
            </div>
        {% endif %}
    </div>
    {% if empresa_filtrada %}
        <div class="alert alert-info bg-primary bg-opacity-10 border-primary border-opacity-25 d-flex justify-content-between align-items-center mb-3">
            <span><i class="bi bi-funnel-fill me-2"></i>Filtrando pedidos da empresa selecionada</span>
            <a href="{% url 'lista_pedidos' %}" class="btn btn-sm btn-outline-primary rounded-pill">
                <i class="bi bi-x-lg me-1"></i>Limpar Filtro
            </a>
        </div>
    {% endif %}

    <div class="card shadow-sm border-0 bg-card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <div class="card bg-dark border-secondary mb-3">
                    <div class="card-body">
                        <form method="get" class="row g-2 align-items-end">
                            <input type="hidden" name="sort" value="{{ current_sort }}">
                            {% if empresa_filtrada %}<input type="hidden" name="empresa" value="{{ empresa_filtrada }}">{% endif %}

                            <div class="col-md-2">
                                <label class="text-white small fw-bold">Data Início</label>
                                <input type="date" name="data_inicio" class="form-control form-control-sm bg-secondary text-white border-0" value="{{ filtros.data_inicio }}">
                            </div>
                            
                            <div class="col-md-2">
                                <label class="text-white small fw-bold">Data Fim</label>
                                <input type="date" name="data_fim" class="form-control form-control-sm bg-secondary text-white border-0" value="{{ filtros.data_fim }}">
                            </div>

                            <div class="col-md-3">
                                <label class="text-white small fw-bold">Solicitante</label>
                                <select name="solicitante" class="form-select form-select-sm bg-secondary text-white border-0">
                                    <option value="">Todos</option>
                                    {% for u in usuarios_filtro %}
                                        <option value="{{ u.id }}" {% if filtros.solicitante == u.id|stringformat:"i" %}selected{% endif %}>{{ u.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="text-white small fw-bold">Empresa Destino</label>
                                <select name="empresa" class="form-select form-select-sm bg-secondary text-white border-0">
                                    <option value="">Todas as Empresas</option>
                                    {% for empresa in empresas_todas %}
                                        <option value="{{ empresa.id }}" {% if filtros.empresa == empresa.id|stringformat:"i" %}selected{% endif %}>
                                            {{ empresa.nome_fantasia }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-2 d-flex gap-1">
                                <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                                    <i class="bi bi-search">Buscar</i>
                                </button>
                                <a href="{% url 'lista_pedidos' %}" class="btn btn-outline-light btn-sm">
                                    <i class="bi bi-eraser">Limpar</i>
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
                <table class="table table-dark table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th>
                                <a href="?sort={% if current_sort == 'data_solicitacao' %}-data_solicitacao{% else %}data_solicitacao{% endif %}&data_inicio={{ filtros.data_inicio }}&data_fim={{ filtros.data_fim }}&solicitante={{ filtros.solicitante }}&destinatario={{ filtros.destinatario }}{% if empresa_filtrada %}&empresa={{ empresa_filtrada }}{% endif %}" class="text-white text-decoration-none">
                                    DATA <i class="bi bi-arrow-down-up"></i>
                                </a>
                            </th>
                            <th>
                                <a href="?sort={% if current_sort == 'titulo' %}-titulo{% else %}titulo{% endif %}{% if empresa_filtrada %}&empresa={{ empresa_filtrada }}{% endif %}" class="text-white text-decoration-none">
                                    PEDIDO / TÍTULO 
                                    <i class="bi {% if current_sort == 'titulo' %}bi-sort-alpha-down{% elif current_sort == '-titulo' %}bi-sort-alpha-up{% else %}bi-arrow-down-up{% endif %}"></i>
                                </a>
                            </th>
                            <th>
                                <a href="?sort={% if current_sort == 'usuario_solicitante__username' %}-usuario_solicitante__username{% else %}usuario_solicitante__username{% endif %}{% if empresa_filtrada %}&empresa={{ empresa_filtrada }}{% endif %}" class="text-white text-decoration-none">
                                    SOLICITANTE
                                </a>
                            </th>
                            <th>
                                <a href="?sort={% if current_sort == 'usuario_destinatario__username' %}-usuario_destinatario__username{% else %}usuario_destinatario__username{% endif %}{% if empresa_filtrada %}&empresa={{ empresa_filtrada }}{% endif %}" class="text-white text-decoration-none">
                                    DESTINATÁRIO
                                </a>
                            </th>
                            <th>
                                <a href="?sort={% if current_sort == 'concluido' %}-concluido{% else %}concluido{% endif %}{% if empresa_filtrada %}&empresa={{ empresa_filtrada }}{% endif %}" class="text-white text-decoration-none">
                                    STATUS
                                </a>
                            </th>
                            <th class="text-end">AÇÕES</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos %}
                        <tr class="border-bottom border-secondary border-opacity-10">
                            <td>{{ pedido.data_solicitacao|date:"d/m/Y H:i" }}</td>
                            <td class="text-white">
                                <a href="#" class="text-info text-decoration-none" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalDescricao{{ pedido.id }}">
                                    {{ pedido.titulo }}
                                </a>

                                <div class="modal fade" id="modalDescricao{{ pedido.id }}" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content bg-dark text-white border-secondary">
                                            <div class="modal-header border-secondary">
                                                <h5 class="modal-title">{{ pedido.titulo }}</h5>
                                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <h6>Instruções detalhadas:</h6>
                                                <div class="text-light bg-dark p-3 rounded border border-secondary" style="min-height: 100px;">
                                                    {% if pedido.descricao_solicitacao %}
                                                        {{ pedido.descricao_solicitacao|linebreaks }}
                                                    {% else %}
                                                        <span class="text-muted italic">Nenhuma instrução detalhada foi fornecida para este pedido.</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="modal-footer border-secondary">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                                {% if pedido.status == 'Pendente' %}
                                                    <a href="{% url 'enviar_arquivo' pedido.id %}" class="btn btn-primary">Enviar Arquivo Agora</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="text-info">
                                    <i class="bi bi-person-fill me-1"></i>{{ pedido.usuario_solicitante.username }}
                                </span>
                                <div class="text" style="font-size: 0.7rem;">{{ pedido.setor_solicitante.nome }}</div>
                            </td>
                            <td>
                                <span class="text-warning">
                                    <i class="bi bi-building me-1"></i>{{ pedido.empresa_destino.nome_fantasia }}
                                </span>
                            </td>
                            <td>
                                {% if pedido.concluido %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 rounded-pill">Recebido</span>
                                {% else %}
                                    <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill">Pendente</span>
                                {% endif %}
                            </td>
                            
                            <td class="text-end pe-4">
                                {% if user.tipo == 'CONTABILIDADE' or user.tipo == 'ADMIN_CONTABILIDADE' %}
                                    {# VISÃO DA CONTABILIDADE #}
                                    <div class="d-flex justify-content-end gap-2">
                                        {% if pedido.arquivo_enviado %}
                                            <a href="{{ pedido.arquivo_enviado.url }}" class="btn btn-sm btn-success rounded-pill px-3" target="_blank">
                                                <i class="bi bi-cloud-arrow-down me-1"></i> Download
                                            </a>
                                        {% else %}
                                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill d-flex align-items-center">
                                                <i class="bi bi-hourglass-split me-1"></i> Aguardando Cliente
                                            </span>
                                        {% endif %}

                                        {% if not pedido.concluido %}
                                            <button class="btn btn-outline-danger btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#modalExcluir{{ pedido.id }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        {% else %}
                                            <span class="text-muted small align-self-center" title="Pedidos recebidos não podem ser excluídos">
                                                <i class="bi bi-lock-fill"></i>
                                            </span>
                                        {% endif %}
                                    </div>

                                    {# Modal de Exclusão (Dentro do IF da Contabilidade) #}
                                    <div class="modal fade" id="modalExcluir{{ pedido.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content bg-dark text-white border-danger">
                                                <form action="{% url 'excluir_pedido' pedido.id %}" method="POST">
                                                    {% csrf_token %}
                                                    <div class="modal-header border-danger">
                                                        <h5 class="modal-title text-danger">Confirmar Exclusão</h5>
                                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                                    </div>
                                                    <div class="modal-body text-start">
                                                        <p>Você está excluindo o pedido: <strong>{{ pedido.titulo }}</strong></p>
                                                        <label class="small fw-bold">Justificativa (Obrigatório):</label>
                                                        <textarea name="justificativa" class="form-control bg-secondary text-white border-0" required placeholder="Ex: Erro na competência..."></textarea>
                                                    </div>
                                                    <div class="modal-footer border-0">
                                                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                                                        <button type="submit" class="btn btn-danger btn-sm">Confirmar Exclusão</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                {% else %}
                                    {# VISÃO DO CLIENTE #}
                                    {% if pedido.arquivo_enviado %}
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-success rounded-pill px-3 me-2" disabled>
                                                <i class="bi bi-check2-all me-1"></i> Enviado
                                            </button>
                                            <a href="{% url 'responder_pedido' pedido.id %}" class="btn btn-sm btn-outline-primary rounded-pill" title="Substituir arquivo">
                                                <i class="bi bi-arrow-repeat"></i>
                                            </a>
                                        </div>
                                    {% else %}
                                        <a href="{% url 'responder_pedido' pedido.id %}" class="btn btn-sm btn-primary rounded-pill px-4 shadow-sm">
                                            <i class="bi bi-upload me-2"></i>Enviar Arquivo
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center py-4 text-muted">Nenhum pedido registrado.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    /* Estilos Adicionais para a Tabela */
    .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.02) !important;
    }
    
    .btn-accent {
        background-color: var(--accent-blue);
        color: white;
        border: none;
    }
    
    .btn-accent:hover {
        background-color: #1f6feb;
        color: white;
    }

    .table thead th {
        font-weight: 600;
        border-top: none;
    }

    .text-main { color: #e6edf3; }
</style>
{% endblock %}