{% extends 'documentos/base.html' %}
{% block content %}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4 d-print-none">
        <h2 class="text-danger"><i class="bi bi-shield-lock me-2"></i>Central de Justificativas e Exclusões</h2>
        <button onclick="window.print()" class="btn btn-outline-secondary">
            <i class="bi bi-printer me-2"></i>Imprimir Relatório
        </button>
    </div>

    <div class="card shadow-sm mb-4 d-print-none">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Empresa</label>
                    <select name="empresa" class="form-select">
                        <option value="">Todas</option>
                        {% for e in empresas %}<option value="{{ e.id }}" {% if filtros.empresa == e.id|stringformat:"i" %}selected{% endif %}>{{ e.nome_fantasia }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Quem Excluiu</label>
                    <select name="usuario" class="form-select">
                        <option value="">Todos</option>
                        {% for u in usuarios %}<option value="{{ u.id }}" {% if filtros.usuario == u.id|stringformat:"i" %}selected{% endif %}>{{ u.username }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Início</label>
                    <input type="date" name="data_inicio" class="form-control" value="{{ filtros.data_inicio }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fim</label>
                    <input type="date" name="data_fim" class="form-control" value="{{ filtros.data_fim }}">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                </div>
            </form>
        </div>
    </div>

    <form method="POST">
        {% csrf_token %}
        <div class="card shadow">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="tabelaExclusao">
                    <thead class="table-dark">
                        <tr>
                            <th class="d-print-none"><input type="checkbox" id="selectAll"></th>
                            <th>Data Solicit.</th>
                            <th>Título do Pedido</th>
                            <th>Empresa</th>
                            <th>Responsável Exclusão</th>
                            <th>Justificativa</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos %}
                        <tr>
                            <td class="d-print-none"><input type="checkbox" name="pedidos_selecionados" value="{{ pedido.id }}"></td>
                            <td>{{ pedido.data_solicitacao|date:"d/m/Y H:i" }}</td>
                            <td>{{ pedido.titulo }}</td>
                            <td>{{ pedido.empresa_destino.nome_fantasia }}</td>
                            <td>{{ pedido.usuario_exclusao.username }}</td>
                            <td class="text-muted italic small">{{ pedido.justificativa_exclusao }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="card-footer d-print-none text-end">
                <button type="submit" name="excluir_definitivo" class="btn btn-danger" onclick="return confirm('ATENÇÃO: Os itens selecionados serão apagados permanentemente do banco de dados. Confirmar?')">
                    <i class="bi bi-trash3-fill me-2"></i>Excluir Definitivamente Selecionados
                </button>
            </div>
        </div>
    </form>
</div>
<small>Gerado em: {% now "d/m/Y H:i" %}</small>
<script>
    // Script simples para marcar/desmarcar todos
    document.getElementById('selectAll').onclick = function() {
        var checkboxes = document.getElementsByName('pedidos_selecionados');
        for (var checkbox of checkboxes) {
            checkbox.checked = this.checked;
        }
    }
    window.onbeforeprint = function() {
        // Selecionamos todas as linhas do corpo da tabela
        const linhas = document.querySelectorAll('#tabelaExclusao tbody tr');
        
        linhas.forEach(linha => {
            const checkbox = linha.querySelector('input[name="pedidos_selecionados"]');
            // Se o checkbox NÃO estiver marcado, adicionamos a classe que esconde
            if (checkbox && !checkbox.checked) {
                linha.classList.add('d-none-print-force'); 
            }
        });
    };

    window.onafterprint = function() {
        // Ao terminar a impressão, removemos a classe para tudo voltar ao normal na tela
        const linhas = document.querySelectorAll('#tabelaExclusao tbody tr');
        linhas.forEach(linha => {
            linha.classList.remove('d-none-print-force');
        });
    };
</script>

<style>
    /* Estilo para a tela do computador */
    .col-justificativa {
        font-size: 0.85rem;
        color: #666;
        word-break: break-all;
    }

    @media print {
        /* Regra crucial para o JavaScript funcionar */
        .d-none-print-force {
            display: none !important;
        }

        /* Configurações da folha */
        @page {
            
            margin: 1cm;
        }

        /* Esconder elementos do sistema */
        nav, .sidebar, .navbar, .d-print-none, button, .card-footer, .breadcrumb, .card-header {
            display: none !important;
        }

        /* Mostrar o cabeçalho de relatório */
        .d-print-block {
            display: block !important;
        }

        body {
            background-color: white !important;
            padding: 0;
            margin: 0;
        }

        .container-fluid {
            width: 100% !important;
            padding: 0 !important;
        }

        /* Tabela de Impressão */
        .table {
            width: 100% !important;
            border: 1px solid #000 !important;
            table-layout: fixed; /* Previne que a tabela estique além da conta */
        }

        .table th, .table td {
            border: 1px solid #000 !important;
            font-size: 8pt !important;
            padding: 4px !important;
            color: black !important;
        }

        /* Ocultar a coluna de checkboxes na impressão */
        th:first-child, td:first-child {
            display: none !important;
        }

        /* Ajuste de largura das colunas na folha */
        th:nth-child(2) { width: 12%; } /* Data */
        th:nth-child(3) { width: 18%; } /* Título */
        th:nth-child(4) { width: 15%; } /* Empresa */
        th:nth-child(5) { width: 12%; } /* Usuário */
        th:nth-child(6) { width: 43%; } /* Justificativa */

        .col-justificativa {
            white-space: normal !important;
            text-align: left;
        }
    }
</style>
{% endblock %}